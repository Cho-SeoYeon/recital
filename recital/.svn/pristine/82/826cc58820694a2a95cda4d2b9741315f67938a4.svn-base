<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.ILicenseMapper">

 <!-- 자격증 신청 내역 조건문 -->
    <!-- 셀렉트바이용 검색 -->
    <!-- 학과 조건문 -->
    <sql id="departmentCondition">
        <if test="searchDept != null and searchDept != '99'">
            and d.dept_no = #{searchDept}
        </if>
    </sql>
    
    <!-- 처리 상태 조건문 -->
    <sql id="statusCondition">
         <if test="searchStatus != '' and searchStatus == 1">
            and sr.com_det_c_no = 'C0201'
        </if>
         <if test="searchStatus != '' and searchStatus == 2">
            and sr.com_det_c_no = 'C0202'
        </if>
         <if test="searchStatus != '' and searchStatus == 3">
            and sr.com_det_c_no = 'C0203'
        </if>
    </sql>
    
    <!-- 학번 조건문 -->
	<sql id="studentIdCondition">
	    <if test="searchStuId != null  and !searchStuId.isEmpty()">
	        and sr.stu_no like '%' || #{searchStuId} || '%'
	    </if>
	</sql>
	
	 <!-- 학생 이름 조건문 -->
    <sql id="studentNameCondition">
        <if test="searchStuName != null and !searchStuName.isEmpty()">
            and st.stu_name like '%' || #{searchStuName} || '%'
        </if>
    </sql>
    


<!-- 학생 -->

 <!-- 자격증 등록 -->
    <insert id="insertLicense" parameterType="licenseVO">
        <selectKey keyProperty="licNo" resultType="String" order="BEFORE">
            select 'LIC_'||seq_license.nextval from dual
        </selectKey>
        insert into license(
            lic_no,
            stu_no,
            lic_name,
            lic_content,
            lic_limit,
            lic_date,
            com_det_c_no,
            lic_regdate,
            file_group_no,
            rej_content
        ) values(
            #{licNo},
            #{stuNo},
            #{licName},
            #{licContent},
            #{licLimit},
            #{licDate},
            'C0202',
            to_char(sysdate, 'YYYY/MM/DD'),
            null,
            null
        )
    </insert>
    
    <update id="insertFileGroupNoToLicense" parameterType="licenseVO">
        update license
        set 
           	file_group_no = #{fileGroupNo}
        where lic_name = #{licName}
    </update>
    
    <!-- 본인이 신청한 자격증 내역 조회 -->
    <select id="myLicenseList" parameterType="String" resultType="licenseVO">
       select
			lic_no
			, lic_name
			, lic_content
			, to_char(sysdate, 'YYYY/mm/dd')as lic_limit
			, to_char(sysdate, 'YYYY/mm/dd')as lic_date
			, to_char(sysdate, 'YYYY/mm/dd')as lic_regdate
			, rej_content 
			, com_det_c_no
			from license
			where stu_no = #{stuNo}
    </select>

    <!-- 상세보기 -->
    <select id="licenseDetail" parameterType="String" resultType="licenseVO">
	   select
			     lic_name
			    ,lic_content
			    , to_char(sysdate, 'YYYY/mm/dd')as lic_limit
			    , to_char(sysdate, 'YYYY/mm/dd')as lic_date
			    , to_char(sysdate, 'YYYY/mm/dd')as lic_regdate
			    , rej_content
			    , com_det_c_no
		from license
		where lic_no = #{licNo}
    </select>
    
    <!-- 페이징 처리를 위한 자격증 신청 count-->
    <select id="selectLicenseRequestCount" parameterType="map" resultType="int">
      select count(l.lic_no)
        from license l
        join student st on l.stu_no = st.stu_no
        join department d on st.dept_no = d.dept_no
        where 1=1
        <include refid="departmentCondition"/>
        <include refid="statusCondition"/>
        <include refid="studentIdCondition"/>
        <include refid="studentNameCondition"/>
    </select>
    
    

	<!-- 페이징 처리 + 검색 + 필터링 기능된 자격증 신청 내역 조회 -->
	<select id="selectLicenseRequestList" parameterType="pagingVO" resultType="licenseVO">
		select
            c.*, st.stu_name as stuName, d.dept_name as deptName
        from (
            select
                a.*, row_number() over(order by a.sch_rec_no) as rnum
            from (
                select 
                    , l.lic_no
                    , l.lic_name
                    , l.lic_content
                    , to_char(l.lic_limit, 'YYYY/MM/DD') as lic_limit
                    , l.stu_no
                    , to_char(l.lic_date, 'YYYY/MM/DD') as lic_date
                    , to_char(l.lig_regdate, 'YYYY/MM/DD') as lic_regdate
                    , l.rej_content
                    , st.dept_no
                    , d.dept_name
                    , l.com_det_c_no
                from license l
                join student st on l.stu_no = st.stu_no
                join department d on st.dept_no = d.dept_no
                where 1=1
                <include refid="departmentCondition"/>
                <include refid="statusCondition"/>
                <include refid="studentIdCondition"/>
       		    <include refid="studentNameCondition"/>
            ) a
        ) c
        join student st on c.stu_no = st.stu_no
        join department d on st.dept_no = d.dept_no
        <![CDATA[
            where c.rnum >= #{startRow} and c.rnum <= #{endRow}
        ]]>
	
	</select>
	
        
	

</mapper>












